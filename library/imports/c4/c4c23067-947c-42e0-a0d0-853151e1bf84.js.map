{"version":3,"sources":["../../../../../assets/scripts/map/assets/scripts/map/render_quartree.js"],"names":["util","require","RenderQuartree","cc","Class","extends","Node","properties","start","ctor","onLoad","on","event","log","currentTarget","color","Color","GREEN","bind","RED","initQuartree","data","map","n","anchorX","anchorY","width","pixelRect","height","group","rigidbody","addComponent","RigidBody","enabledContactListener","bullut","type","RigidBodyType","Static","allowSleep","gravityScale","fixedRotation","collider","PhysicsBoxCollider","enabled","offset","Vec2","size","Size","Rect","x","center","parent","y","lu","ld","ru","rd","addChild","block","newBlock","getBlockInPool","entity","load","putBlockToPool","setRigidbody","ifEntity","childBroken","undefined","dump","DATATYPE","QUARTREE","module","exports"],"mappings":"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","file":"render_quartree.js","sourceRoot":"../../../../../assets/scripts/map","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\nconst util = require(\"../base/util\");\n\nvar RenderQuartree = cc.Class({\n    extends: cc.Node,\n\n    properties: {\n\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n    start() {\n\n    },\n\n    // update (dt) {},\n\n    ctor() {\n\n    },\n\n    onLoad() {\n        this.on(\"mousemove\", function (event) {\n            cc.log(\"mousemove\", event.currentTarget);\n            this.color = new cc.Color(cc.Color.GREEN);\n        }.bind(this));\n\n        this.on(\"mouseleave\", function (event) {\n            cc.log(\"mouseleave\", event.currentTarget);\n\n            this.color = new cc.Color(cc.Color.RED);\n        }.bind(this));\n    },\n\n    initQuartree(data, map) {\n\n        this.map = map;\n\n        /* 複用屬性設置 */\n        this.n = data.n;\n        this.anchorX = 0.5;\n        this.anchorY = 0.5;\n        this.width = data.pixelRect[2];\n        this.height = data.pixelRect[3];\n        this.group = \"block\";\n\n        /* 設置剛體 */\n        this.rigidbody = this.addComponent(cc.RigidBody);\n        //this.rigidbody.enabled = false;\n        this.rigidbody.enabledContactListener = false;\n        this.rigidbody.bullut = false;\n        this.rigidbody.type = cc.RigidBodyType.Static;\n        this.rigidbody.allowSleep = true;\n        this.rigidbody.gravityScale = 0;\n        this.rigidbody.fixedRotation = false;\n\n        /* 設置碰撞體 */\n        this.collider = this.addComponent(cc.PhysicsBoxCollider);\n        this.collider.enabled = false;\n        this.collider.offset = new cc.Vec2(0, 0);\n        this.collider.size = new cc.Size(data.pixelRect[2], data.pixelRect[3]);\n\n        /* 設置位置，為 cc.Rect 對象 */\n        this.pixelRect = new cc.Rect(\n            data.pixelRect[0] - data.pixelRect[2] / 2,\n            data.pixelRect[1] - data.pixelRect[3] / 2,\n            data.pixelRect[2],\n            data.pixelRect[3]\n        );\n\n        this.x = this.pixelRect.center.x - this.parent.pixelRect.center.x;\n        this.y = this.pixelRect.center.y - this.parent.pixelRect.center.y;\n\n        //cc.log(`init quertree ${this.n} on ${this.x} ${this.y} `);\n\n        /* 生成子四叉樹 or 磚塊 */\n        if (data.n > 0) {\n            this.lu = new RenderQuartree();\n            this.ld = new RenderQuartree();\n            this.ru = new RenderQuartree();\n            this.rd = new RenderQuartree();\n            this.addChild(this.lu);\n            this.addChild(this.ld);\n            this.addChild(this.ru);\n            this.addChild(this.rd);\n            this.lu.initQuartree(data.lu, this.map);\n            this.ld.initQuartree(data.ld, this.map);\n            this.ru.initQuartree(data.ru, this.map);\n            this.rd.initQuartree(data.rd, this.map);\n\n        } else {\n\n            /* 如果需要磚塊則創建 */\n            if (data.block) {\n\n                let newBlock = this.map.getBlockInPool();\n\n                newBlock.x = 0;\n                newBlock.y = 0;\n                newBlock.enabled = true;\n\n                this.block = newBlock;\n                this.addChild(newBlock);\n\n                //cc.log(`init block on ${newBlock.x} ${newBlock.y} `);\n            }\n\n        }\n\n        /* 設置實體 */\n        this.entity = data.entity;\n    },\n\n    /* 加載數據，用於二次數據加載 */\n    load(data) {\n        /* 設置位置，為 cc.Rect 對象 */\n        this.pixelRect = new cc.Rect(\n            data.pixelRect[0] - data.pixelRect[2] / 2,\n            data.pixelRect[1] - data.pixelRect[3] / 2,\n            data.pixelRect[2],\n            data.pixelRect[3]\n        );\n\n        this.x = this.pixelRect.center.x - this.parent.pixelRect.center.x;\n        this.y = this.pixelRect.center.y - this.parent.pixelRect.center.y;\n\n        /* 更新節點屬性 */\n        if (data.n > 0) {\n            this.lu.load(data.lu);\n            this.ld.load(data.ld);\n            this.ru.load(data.ru);\n            this.rd.load(data.rd);\n        } else {\n\n            if (true === data.block && !this.block) {\n                let newBlock = this.map.getBlockInPool();\n\n                newBlock.x = 0;\n                newBlock.y = 0;\n                newBlock.enabled = true;\n\n                this.block = newBlock;\n                this.addChild(newBlock);\n                //cc.log(`reload block on ${newBlock.x} ${newBlock.y} `);\n\n            } else if (true != data.block && this.block) {\n                this.map.putBlockToPool(this.block);\n                delete this.block;\n            }\n        }\n\n        this.entity = data.entity;\n    },\n\n    setRigidbody() {\n\n        /* 為實體時設置剛體和碰撞，否則設置子節點 */\n        //cc.log(`setRigidbody ${\" \".repeat(this.n)}${this.n} ${this.pixelRect.center.x}, ${this.pixelRect.center.x} entity ${this.ifEntity()}`);\n\n        if (this.ifEntity()) {\n            //cc.log(`${\" \".repeat(this.n)}${this.n} ${this.pixelRect.center.x}, ${this.pixelRect.center.x} block off`);\n\n            this.collider.enabled = true;\n        }\n        else {\n            this.collider.enabled = false;\n\n            /* 非實體，非葉節點則往下通知 */\n            if (this.n > 0) {\n                this.lu.setRigidbody();\n                this.ld.setRigidbody();\n                this.ru.setRigidbody();\n                this.rd.setRigidbody();\n            }\n        }\n    },\n\n    childBroken() {\n        if (!this.entity) {\n            return;\n        }\n\n        this.entity = false;\n\n        /* 只有本節點實體生效的情況下才關閉，并通知子節點 */\n        if (this.collider.enabled) {\n            //this.rigidbody.enabled = false;\n            this.collider.enabled = false;\n\n            this.lu.setRigidbody();\n            this.ld.setRigidbody();\n            this.ru.setRigidbody();\n            this.rd.setRigidbody();\n        }\n        else\n        /* 不然就通知父節點 */ {\n            this.parent.childBroken();\n        }\n    },\n\n    /* 等到用到的時候再去計算 */\n    ifEntity() {\n        /* 判斷 entity 屬性是否存在 */\n        if (null === this.entity || undefined === this.entity) {\n\n            /* 如果不存在就去子組件中獲取 */\n            if (null !== this.block && undefined !== this.block) {\n                if (this.block) {\n                    this.entity = true;\n                } else {\n                    this.entity = false;\n                }\n            }\n            else {\n                this.entity = this.lu.ifEntity()\n                    && this.ld.ifEntity()\n                    && this.ru.ifEntity()\n                    && this.rd.ifEntity();\n            }\n        }\n\n        return this.entity;\n    },\n\n    dump() {\n        let data = {};\n\n        data.type = util.DATATYPE.QUARTREE;\n        data.pixelRect = [\n            this.pixelRect.center.x,\n            this.pixelRect.center.y,\n            this.pixelRect.width,\n            this.pixelRect.height\n        ];\n\n        data.n = this.n;\n        if (this.n > 0) {\n            data.lu = this.lu.dump();\n            data.ld = this.ld.dump();\n            data.ru = this.ru.dump();\n            data.rd = this.rd.dump();\n        }\n        else {\n            data.block = !!this.block;\n        }\n\n        data.entity = this.entity;\n\n        return data;\n    }\n});\n\nmodule.exports = RenderQuartree;\n"]}